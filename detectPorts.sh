#!/bin/sh
# detects all open port with binding on all interfaces

for protocol in tcp tcp6 udp udp6 raw raw6 ; do
    if [ -e /proc/net/$protocol ]; then
      for S_PID in $(ls /proc/ | grep "^[0-9]*$" | sort -g); do 
	if [ -d /proc/$S_PID/fd/ ]; then
	  for i in $(ls -lisaF /proc/$S_PID/fd/ | grep -o 'socket:\[[0-9]*\]' | grep -o '[0-9]*'); do 
	    PORT=$(cat /proc/net/$protocol | grep $i | awk '{ print $2; }' | grep 00000000: | awk -v 'FS=:' '{ print $2;}' | awk '{cmd="printf %d 0x" $1; cmd | getline decimal; close(cmd); print decimal}';)
	    if [ ! -z $PORT ]; then
	      S_COMMAND="$(ps --no-headers -p $S_PID -o command)"
	      S_USER=$(ps --no-headers -p $S_PID -o user)
	      echo "$protocol PID:$S_PID  user:$S_USER  port:$PORT  command: $S_COMMAND"
	    fi
	  done
	fi
      done
    fi
done

